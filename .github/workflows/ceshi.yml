name: ceshi
run-name: Release - ${{ inputs.model }}

on:
  schedule:
    - cron: '10 2 * * *'  
  workflow_dispatch:
    inputs:
      model:
        required: true
        description: Device Model
        type: choice
        default: jdcloud_ipq60xx_libwrt
        options:
          - aliyun_ap8220_immwrt
          - cmcc_rax3000m_immwrt
          - gemtek_w1701k_immwrt
          - jdcloud_ax6000_immwrt
          - jdcloud_ipq60xx_immwrt
          - jdcloud_ipq60xx_libwrt
          - linksys_mx4x00_immwrt
          - n1_immwrt
          - qihoo_360v6_immwrt
          - redmi_ax5_immwrt
          - redmi_ax6_immwrt
          - redmi_ax6_libwrt
          - redmi_ax6000_immwrt21
          - zn_m2_immwrt
          - zn_m2_libwrt
          - x64_immwrt

env:
  GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-24.04]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Free disk space
        uses: sbwml/actions@free-disk

      - name: Build System Setup
        run: |
          sudo bash -c 'bash <(curl -sL https://build-scripts.immortalwrt.org/init_build_environment.sh)'
          sudo -E apt -yqq install dos2unix
          sudo -E apt -yqq install libfuse-dev
          sudo -E apt -yqq autoremove --purge
          sudo -E apt -yqq autoclean
          sudo -E apt -yqq clean
          sudo -E systemctl daemon-reload

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Build Date and Timezone
        run: |
          sudo -E timedatectl set-timezone "Asia/Shanghai"
          export BUILD_DATE=$(TZ=UTC-8 date +"%y.%m.%d_%H.%M.%S")
          echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
          export BUILD_SRC=$(awk -F"=" '/REPO_URL/ {print $NF}' "./compilecfg/${{ inputs.model }}.ini")
          echo "BUILD_SRC=$BUILD_SRC" >> $GITHUB_ENV

      - name: Pre Clone
        run: ./pre_clone_action.sh ${{ inputs.model }}

      - name: Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ./action_build/.ccache
            ./action_build/staging_dir
          key: ${{ matrix.os }}-${{ hashFiles('**/repo_flag') }}-${{ env.BUILD_DATE }}
          restore-keys: |
            ${{ matrix.os }}-${{ hashFiles('**/repo_flag') }}-

      - name: Refresh the cache
        run: |
          if [ -d "./action_build/staging_dir" ]; then
            find "./action_build/staging_dir" -type d -name "stamp" -not -path "*target*" | while read -r dir; do
                find "$dir" -type f -exec touch {} +
            done
          fi
          
      - name: Fix libnatpmp CMake Issue
        run: |
          if [ -f "./action_build/feeds/packages/libs/libnatpmp/CMakeLists.txt" ]; then
            echo "=== 调试信息 ==="
            echo "文件存在，开始修复..."
            echo "原文件前5行内容："
            head -5 "./action_build/feeds/packages/libs/libnatpmp/CMakeLists.txt"
            
            echo "=== 执行修复 ==="
            # 多种匹配方式确保修复成功
            sed -i 's/cmake_minimum_required(VERSION 2\.[0-9])/cmake_minimum_required(VERSION 3.5)/g' "./action_build/feeds/packages/libs/libnatpmp/CMakeLists.txt"
            sed -i 's/cmake_minimum_required(VERSION 2\.6)/cmake_minimum_required(VERSION 3.5)/g' "./action_build/feeds/packages/libs/libnatpmp/CMakeLists.txt"
            sed -i 's/cmake_minimum_required(VERSION 2\.8)/cmake_minimum_required(VERSION 3.5)/g' "./action_build/feeds/packages/libs/libnatpmp/CMakeLists.txt"
            
            echo "修复后文件前5行内容："
            head -5 "./action_build/feeds/packages/libs/libnatpmp/CMakeLists.txt"
            echo "=== 修复完成 ==="
          else
            echo "错误：libnatpmp CMakeLists.txt 文件不存在"
            find "./action_build" -name "CMakeLists.txt" | grep libnatpmp || echo "未找到相关文件"
          fi

      - name: Debug - Find advancedplus package
        run: |
          echo "=== 查找 advancedplus 相关软件包 ==="
          find ./action_build -name "*advancedplus*" -type d 2>/dev/null || echo "未找到 advancedplus 相关目录"
          echo "=== 查找 luci-app 相关软件包 ==="
          find ./action_build/feeds -name "*luci-app*" -type d | head -20
          echo "=== 检查软件包 feeds ==="
          ls -la ./action_build/feeds/ || echo "feeds 目录不存在"
          echo "=== 检查 package 目录 ==="
          ls -la ./action_build/package/ 2>/dev/null || echo "package 目录不存在"

      - name: Debug - Check defconfig
        run: |
          echo "=== 检查 defconfig 配置 ==="
          if [ -f "./compilecfg/${{ inputs.model }}.defconfig" ]; then
            grep -i "advancedplus" "./compilecfg/${{ inputs.model }}.defconfig" || echo "defconfig 中未找到 advancedplus 配置"
          else
            echo "defconfig 文件不存在"
          fi
          
      - name: Debug - Check feeds configuration
        run: |
          echo "=== 检查 feeds 配置 ==="
          if [ -f "./action_build/feeds.conf" ]; then
            cat "./action_build/feeds.conf"
          elif [ -f "./action_build/feeds.conf.default" ]; then
            cat "./action_build/feeds.conf.default"
          else
            echo "未找到 feeds 配置文件"
          fi

      
